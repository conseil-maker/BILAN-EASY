# =============================================================================
# BILAN-EASY Pull Request Check
# =============================================================================
# Ce workflow s'exÃ©cute uniquement sur les pull requests
# Il fournit des commentaires automatiques sur la qualitÃ© du code
# =============================================================================

name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-analysis:
    name: ðŸ“ PR Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour la comparaison des commits

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”§ Build project
        run: npm run build

      - name: ðŸ“Š Analyze changes
        id: analyze
        run: |
          # Compter les fichiers modifiÃ©s
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # Taille du bundle
          BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
          echo "bundle_size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT
          
          # Fichiers TypeScript modifiÃ©s
          TS_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(ts|tsx)$' | wc -l)
          echo "ts_files=$TS_FILES" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.analyze.outputs.changed_files }}';
            const bundleSize = '${{ steps.analyze.outputs.bundle_size }}';
            const tsFiles = '${{ steps.analyze.outputs.ts_files }}';
            
            const body = `## ðŸ“Š PR Analysis Report
            
            | Metric | Value |
            |--------|-------|
            | ðŸ“ Files changed | ${changedFiles} |
            | ðŸ“¦ Bundle size | ${bundleSize} |
            | ðŸ”· TypeScript files | ${tsFiles} |
            
            ### âœ… Checks Passed
            - Build successful
            - TypeScript compilation OK
            
            ---
            *This comment is automatically generated by the CI pipeline.*`;
            
            // Chercher un commentaire existant
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Analysis Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
